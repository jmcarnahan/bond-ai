# Terraform Changes Summary - S3 Connectivity and OAuth Hang Fixes

## Problem Overview
The Bond AI application deployed successfully but experienced two critical issues:
1. **S3 connectivity timeouts** - Backend crashed when trying to connect to S3 after Okta authentication
2. **OAuth flow hangs** - Backend hung during authentication flow due to missing VPC endpoints for AWS services

## Root Cause
App Runner was configured with **VPC egress mode** but the existing VPC lacked proper **VPC endpoints** for AWS services. Traffic was routing through private subnets without internet access or VPC endpoints, causing timeouts.

---

## Changes Made

### 1. **Created VPC Endpoints Configuration**

**File:** `deployment/terraform-existing-vpc/vpc-endpoints.tf` *(NEW FILE)*

```hcl
# VPC Endpoints for AWS services

# VPC Endpoint for S3 (Gateway type - FREE, no security groups needed)
resource "aws_vpc_endpoint" "s3" {
  vpc_id            = data.aws_vpc.existing.id
  service_name      = "com.amazonaws.${var.aws_region}.s3"
  vpc_endpoint_type = "Gateway"
  route_table_ids   = concat(data.aws_route_tables.private.ids, [data.aws_route_table.main.id])

  tags = {
    Name = "${var.project_name}-${var.environment}-s3-endpoint"
  }
}

# VPC Endpoint for Secrets Manager (Interface type)
resource "aws_vpc_endpoint" "secretsmanager" {
  vpc_id              = data.aws_vpc.existing.id
  service_name        = "com.amazonaws.${var.aws_region}.secretsmanager"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = local.vpc_endpoint_subnet_ids  # Use subnets in different AZs
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.project_name}-${var.environment}-secretsmanager-endpoint"
  }
}

# VPC Endpoint for Bedrock (Interface type)
resource "aws_vpc_endpoint" "bedrock" {
  vpc_id              = data.aws_vpc.existing.id
  service_name        = "com.amazonaws.${var.aws_region}.bedrock-runtime"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = local.vpc_endpoint_subnet_ids  # Use subnets in different AZs
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.project_name}-${var.environment}-bedrock-endpoint"
  }
}

# VPC Endpoint for CloudWatch Logs (Interface type)
resource "aws_vpc_endpoint" "logs" {
  vpc_id              = data.aws_vpc.existing.id
  service_name        = "com.amazonaws.${var.aws_region}.logs"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = local.vpc_endpoint_subnet_ids  # Use subnets in different AZs
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = false  # Disabled due to existing conflicting DNS domain

  tags = {
    Name = "${var.project_name}-${var.environment}-logs-endpoint"
  }
}
```

**Why:** Provides private AWS backbone access for S3, Secrets Manager, Bedrock, and CloudWatch Logs without requiring internet connectivity.

---

### 2. **Updated Route Table Data Sources**

**File:** `deployment/terraform-existing-vpc/data-sources.tf`

**Added main route table data source:**
```hcl
# Get the main route table for the VPC (many subnets use this by default)
data "aws_route_table" "main" {
  vpc_id = data.aws_vpc.existing.id

  filter {
    name   = "association.main"
    values = ["true"]
  }
}
```

**Updated App Runner subnet selection:**
```hcl
# OLD:
app_runner_subnet_ids = data.aws_subnets.private.ids

# NEW:
app_runner_subnet_ids = slice(data.aws_subnets.private.ids, 0, min(3, length(data.aws_subnets.private.ids)))
```

**Added VPC endpoint subnet selection (FIXED DEPLOYMENT ISSUE):**
```hcl
# Select subnets for VPC endpoints (need different AZs for interface endpoints)
vpc_endpoint_subnet_ids = [
  for az in slice(local.availability_zones, 0, min(2, length(local.availability_zones))) :
  [for s in data.aws_subnet.private : s.id if s.availability_zone == az][0]
]
```

**Why:**
- Main route table is what App Runner subnets actually use (not explicitly associated route tables)
- Limiting to 3 subnets provides better control and reduces complexity
- **VPC Interface endpoints require subnets in different availability zones** - this was causing deployment failures

---

### 3. **Added VPC Endpoints Security Group**

**File:** `deployment/terraform-existing-vpc/security.tf`

**Added at end of file:**
```hcl
# Security Group for VPC Interface Endpoints
resource "aws_security_group" "vpc_endpoints" {
  name_prefix = "${var.project_name}-${var.environment}-vpc-endpoints-"
  description = "Security group for VPC interface endpoints"
  vpc_id      = data.aws_vpc.existing.id

  # Allow HTTPS traffic from App Runner security group
  ingress {
    from_port       = 443
    to_port         = 443
    protocol        = "tcp"
    security_groups = [aws_security_group.app_runner.id]
    description     = "HTTPS from App Runner"
  }

  # Allow all outbound
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound"
  }

  tags = {
    Name = "${var.project_name}-${var.environment}-vpc-endpoints-sg"
  }

  lifecycle {
    create_before_destroy = true
  }
}
```

**Why:** Interface VPC endpoints require security groups to allow traffic from App Runner services.

---

### 4. **Updated Backend Memory Configuration**

**File:** `deployment/terraform-existing-vpc/backend.tf`

**Line 80-81 changes:**
```hcl
# OLD:
cpu    = "0.25 vCPU"
memory = "0.5 GB"

# NEW:
cpu    = "0.5 vCPU"
memory = "1 GB"
```

**Why:** Original memory (512MB) was insufficient for Python backend with ML/AI dependencies. Backend was crashing during authentication flow due to memory exhaustion.

---

## Issue Resolution Timeline

1. **S3 Timeout Issue** → Fixed by adding S3 VPC gateway endpoint with main route table
2. **Backend Memory Crashes** → Fixed by increasing memory from 512MB to 1GB
3. **OAuth Flow Hangs** → Fixed by adding Secrets Manager, Bedrock, and CloudWatch Logs VPC endpoints
4. **VPC Endpoint Deployment Failures** → Fixed subnet AZ conflicts and DNS conflicts

## Deployment Issues Encountered & Fixes

### **Issue 1: Duplicate Subnets in Same Zone**
```
Error: DuplicateSubnetsInSameZone: Found another VPC endpoint subnet in the availability zone
```
**Cause:** Interface VPC endpoints require subnets in **different availability zones**
**Fix:** Created `vpc_endpoint_subnet_ids` that selects one subnet per AZ (max 2 AZs)

### **Issue 2: Conflicting DNS Domain**
```
Error: private-dns-enabled cannot be set because there is already a conflicting DNS domain for logs.us-west-2.amazonaws.com
```
**Cause:** Existing VPC endpoint with private DNS enabled for CloudWatch Logs
**Fix:** Set `private_dns_enabled = false` for the logs endpoint

## Cost Impact
- **S3 Gateway Endpoint:** FREE
- **Interface Endpoints:** ~$7/month each (3 endpoints = ~$21/month)
- **Increased Instance Size:** ~$10-15/month additional

## Implementation Checklist

### **Files to Create/Modify**
1. ✅ **NEW FILE**: `vpc-endpoints.tf` - Complete VPC endpoints configuration
2. ✅ **MODIFY**: `data-sources.tf` - Add main route table + AZ-distributed subnets
3. ✅ **MODIFY**: `security.tf` - Add VPC endpoints security group
4. ✅ **MODIFY**: `backend.tf` - Increase memory from 0.5GB to 1GB, CPU from 0.25 to 0.5 vCPU

### **Step-by-Step Implementation Guide**

#### **Step 1: Create VPC Endpoints File**
Create `deployment/terraform-existing-vpc/vpc-endpoints.tf` with the complete code shown above.

#### **Step 2: Update Data Sources**
In `deployment/terraform-existing-vpc/data-sources.tf`:
- Add main route table data source (after line ~58)
- Add VPC endpoint subnet selection to locals block (after line ~37)
- Update app_runner_subnet_ids to use slice() function

#### **Step 3: Add Security Group**
In `deployment/terraform-existing-vpc/security.tf`:
- Add VPC endpoints security group at the end of the file (after existing security groups)

#### **Step 4: Update Backend Resources**
In `deployment/terraform-existing-vpc/backend.tf`:
- Update instance_configuration block (lines ~79-83) with increased memory/CPU

#### **Step 5: Deploy**
```bash
terraform init
terraform plan -var-file=environments/your-config.tfvars
terraform apply -var-file=environments/your-config.tfvars
```

## Files Modified Summary

## Key Lessons Learned
- **VPC egress mode** requires VPC endpoints or NAT Gateway for AWS service access
- **Main route table** is often used by default, not explicitly associated route tables
- **Gateway endpoints** (S3) are free and don't need security groups
- **Interface endpoints** require security groups and cost money but provide secure private access
- **Interface VPC endpoints** MUST use subnets in different availability zones
- **Private DNS conflicts** can occur when multiple VPC endpoints exist for the same service

## Common Pitfalls to Avoid
1. **Using all subnets** for VPC endpoints without checking AZ distribution
2. **Enabling private DNS** without checking for existing conflicting endpoints
3. **Missing main route table** in S3 gateway endpoint associations
4. **Insufficient memory** for ML/AI workloads in containerized environments

## Verification Steps

After deployment, verify the fixes:

1. **Check VPC Endpoints Created**:
   ```bash
   aws ec2 describe-vpc-endpoints --region us-west-2 --filters "Name=vpc-id,Values=YOUR_VPC_ID"
   ```

2. **Test Backend Health**:
   ```bash
   curl https://YOUR_BACKEND_URL/health
   ```

3. **Test Full OAuth Flow**:
   - Access frontend URL
   - Complete Okta authentication
   - Verify successful redirect (no hangs or timeouts)

4. **Check Backend Logs**:
   - Should see successful S3 bucket creation
   - Should see completed Bedrock provider initialization
   - Should see successful OAuth token exchange

## Quick Reference: Before vs After

### **Before (Broken)**
- ❌ S3 timeouts after 60 seconds
- ❌ Backend crashes during auth due to memory limits
- ❌ OAuth flow hangs waiting for AWS service calls
- ❌ VPC endpoint deployment failures

### **After (Working)**
- ✅ S3 access via private VPC endpoint
- ✅ 1GB memory supports ML/AI workloads
- ✅ Complete OAuth flow with all AWS services accessible
- ✅ Clean deployment with proper AZ distribution

These changes ensure the application works reliably in VPC-isolated environments while maintaining security and cost-effectiveness.